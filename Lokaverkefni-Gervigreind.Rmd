---
title: "Lokaverkefni-Gervigreind"
author: "Ævar Ingi Jóhannesson"
date: "4/6/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
```

```{r, warning = F, message = F}
library(plyr); library(dplyr); library(lubridate)
library(ggplot2)
library(grid)
library(gridExtra)
library(glmnet)
library(e1071)
library(randomForest)
library(knitr)
library(gbm)
library(corrplot)
library(caret)
library(mlbench)
library(tictoc)
library(gdata)
```

## Load data:

```{r}
data = read.csv("train.csv")
#remove ID column
data$id = NULL
data.submit = read.csv("test.csv")
id = data.submit$id
```

```{r}
for(i in 1:116){
  print(i)
  k=nlevels(data[,i]) == nlevels(data.submit[,i+1])
  print(k)
}
```


Næstu tvo kodabuta þarf ekki að keyra.. veit ekki hvort við þurfum þa.

Variables with different values in data.submit and data.:
92,96,99,101,102,103,105,106,109,110,113,114,116

```{r,eval=FALSE}
table(data.submit$cat92); table(data$cat92) #sub
table(data.submit$cat96); table(data$cat96) #sub
table(data.submit$cat99); table(data$cat99) #sub
table(data.submit$cat101); table(data$cat101)
table(data.submit$cat102); table(data$cat102)
table(data.submit$cat103); table(data$cat103)
table(data.submit$cat105); table(data$cat105)
table(data.submit$cat106); table(data$cat106)
table(data.submit$cat109); table(data$cat109)
table(data.submit$cat110); table(data$cat110)
table(data.submit$cat113); table(data$cat113)
table(data.submit$cat114); table(data$cat114)
table(data.submit$cat116); table(data$cat116)

names <- c("cat90","cat92","cat96","cat99","cat101","cat102","cat103",
           "cat105","cat106","cat109","cat110","cat113","cat114",
           "cat116")

levels(data.submit[,names[1]])
sub <- levels(data.submit$cat92)
nsub <- levels(data$cat92)
subIn <- unique(c(sub,nsub))
nsubIn <- unique(c(nsub,sub))
levels(data.submit$cat92) <- subIn
levels(data$cat92) <- nsubIn
data.submit[,"cat92"]

which(table(data.submit$cat92) == 1)

```

```{r,eval=FALSE}
for(i in 1:14){
  name <- names[i]
  sub <- levels(data.submit[,name])
  nsub <- levels(data[,name])
  subIn <- unique(c(sub,nsub))
  nsubIn <- unique(c(nsub,sub))
  levels(data.submit[,name]) <- subIn
  levels(data[,name]) <- nsubIn
}
```



```{r}
head(data)[1:5,]
```

116 categorical variables,  14 continous and Loss. 

Check for NA values

```{r}
dim(na.omit(data)) == dim(data)
```

Check distribution of response

```{r}
density1 <- ggplot(data,aes(loss))+
  geom_density(fill = "palegreen2", alpha = 0.4) 

density2 <- ggplot(data,aes(log(loss)))+
  geom_density(fill = "skyblue", alpha = 0.4)

grid.arrange(density1,density2,nrow=2)
```

```{r}
skewness(data$loss)
skewness(log(data$loss))

which(data$loss<1)
#þar er bara eit loss gildi milli 0 og 1. 
data$loss = log(data$loss)
```

## Descriptive plots

Continuous variables
```{r}
p1 = ggplot(data=data, aes(x=cont2,y=loss))+
      geom_point(size=0.4)+ylab("log(loss)")

p2 = ggplot(data=data, aes(x=cont3,y=loss))+
      geom_point(size=0.4)+ylab("log(loss)")

p3 = ggplot(data=data, aes(x=cont13,y=loss))+
      geom_point(size=0.4)+ylab("log(loss)")

p4 = ggplot(data=data, aes(x=cont14,y=loss))+
      geom_point(size=0.4)+ylab("log(loss)")

grid.arrange(p1,p2,p3,p4,nrow = 2)
```

Boxplots of categorical variables
```{r}
ggplot(data=data, aes(x=cat3,y=loss))+
  geom_boxplot()

ggplot(data=data, aes(x=cat7,y=loss))+
  geom_boxplot()

ggplot(data=data, aes(x=cat14,y=loss))+
  geom_boxplot()

ggplot(data=data, aes(x=cat15,y=loss))+
  geom_boxplot()

ggplot(data=data, aes(x=cat79,y=loss))+
  geom_boxplot()

ggplot(data=data, aes(x=cat75,y=loss))+
  geom_boxplot()

table(data$cat75)

ggplot(data=data, aes(x=cat77,y=loss))+
  geom_boxplot()

ggplot(data=data, aes(x=cat87,y=loss))+
  geom_boxplot()

ggplot(data=data, aes(x=cat89,y=loss))+
  geom_boxplot()

table(data$cat89)

ggplot(data=data, aes(x=cat90,y=loss))+
  geom_boxplot()

ggplot(data=data, aes(x=cat93,y=loss))+
  geom_boxplot()

ggplot(data=data, aes(x=cat100,y=loss))+
  geom_boxplot()

ggplot(data=data, aes(x=cat101,y=loss))+
  geom_boxplot()

ggplot(data=data, aes(x=cat102,y=loss))+
  geom_boxplot()

table(data$cat102)

ggplot(data=data, aes(x=cat103,y=loss))+
  geom_boxplot()

ggplot(data=data, aes(x=cat104,y=loss))+
  geom_boxplot()

ggplot(data=data, aes(x=cat105,y=loss))+
  geom_boxplot()

table(data$cat105)

ggplot(data=data, aes(x=cat106,y=loss))+
  geom_boxplot()

ggplot(data=data, aes(x=cat110,y=loss))+
  geom_boxplot()
```

Barplots of categorical variables
```{r}
ggplot(data=data, aes(cat1))+
  geom_bar()
```

## Correlation

```{r}
data.cont = data[,117:131]
cormat = cor(data.cont[,-15])
corrplot(cormat, method = "circle")
highCor = findCorrelation(cormat, cutoff = 0.9)
highCor
?corrplot

#Remove one of the variables: 1 or 9,   11 or 12, 6 og 10?
#hvað með að nota pca á continuous? 
```

```{r}
data.try = data

for(i in 1:116){
  var = eval(parse(text = paste("data.try$cat",as.character(i),sep="")))
  print(i)
  print(table(var))
}

data.try = data.try[data.try$cat75 %in% names(which(table(data.try$cat75) > 10)), ]
data.try = data.try[data.try$cat88 %in% names(which(table(data.try$cat88) > 10)), ]
data.try = data.try[data.try$cat89 %in% names(which(table(data.try$cat89) > 10)), ]
data.try = data.try[data.try$cat90 %in% names(which(table(data.try$cat90) > 10)), ]
data.try = data.try[data.try$cat92 %in% names(which(table(data.try$cat92) > 10)), ]
data.try = data.try[data.try$cat99 %in% names(which(table(data.try$cat99) > 10)), ]
data.try = data.try[data.try$cat101 %in% names(which(table(data.try$cat101) > 10)), ]
data.try = data.try[data.try$cat102 %in% names(which(table(data.try$cat102) > 10)), ]
data.try = data.try[data.try$cat103 %in% names(which(table(data.try$cat103) > 10)), ]
data.try = data.try[data.try$cat104 %in% names(which(table(data.try$cat104) > 10)), ]
data.try = data.try[data.try$cat105 %in% names(which(table(data.try$cat105) > 10)), ]
data.try = data.try[data.try$cat106 %in% names(which(table(data.try$cat106) > 10)), ]
data.try = data.try[data.try$cat107 %in% names(which(table(data.try$cat107) > 10)), ]
data.try = data.try[data.try$cat109 %in% names(which(table(data.try$cat109) > 10)), ]
data.try = data.try[data.try$cat110 %in% names(which(table(data.try$cat110) > 10)), ]
data.try = data.try[data.try$cat111 %in% names(which(table(data.try$cat111) > 10)), ]
data.try = data.try[data.try$cat113 %in% names(which(table(data.try$cat113) > 10)), ]
data.try = data.try[data.try$cat114 %in% names(which(table(data.try$cat114) > 10)), ]
data.try = data.try[data.try$cat115 %in% names(which(table(data.try$cat115) > 10)), ]
data.try = data.try[data.try$cat116 %in% names(which(table(data.try$cat116) > 10)), ]

data.try$cat75  = droplevels(data.try$cat75) ; data.try$cat88  = droplevels(data.try$cat88)
data.try$cat89  = droplevels(data.try$cat89) ; data.try$cat90  = droplevels(data.try$cat90)
data.try$cat92  = droplevels(data.try$cat92) ; data.try$cat99  = droplevels(data.try$cat99)
data.try$cat101 = droplevels(data.try$cat101); data.try$cat102 = droplevels(data.try$cat102)
data.try$cat103 = droplevels(data.try$cat103); data.try$cat104 = droplevels(data.try$cat104)
data.try$cat105 = droplevels(data.try$cat105); data.try$cat106 = droplevels(data.try$cat106)
data.try$cat107 = droplevels(data.try$cat107); data.try$cat109 = droplevels(data.try$cat109)
data.try$cat110 = droplevels(data.try$cat110); data.try$cat111 = droplevels(data.try$cat111)
data.try$cat113 = droplevels(data.try$cat113); data.try$cat114 = droplevels(data.try$cat114)
data.try$cat115 = droplevels(data.try$cat115); data.try$cat116 = droplevels(data.try$cat116)


#lev = levels(data.try$cat75)[c(1,2)]
#data.try = data.try[which(data.try$cat75 %in% lev),]
#data.try$cat75 = droplevels(data.try$cat75)

#drop highly correlated variables
data.try$cont9 = NULL
data.try$cont12 = NULL


#taka út alla sem gefa NA gildi
cat74 = data.try$cat74; data.try$cat74 = NULL
cat81 = data.try$cat81; data.try$cat81 = NULL
cat85 = data.try$cat85; data.try$cat85 = NULL
cat87 = data.try$cat87; data.try$cat87 = NULL
cat89 = data.try$cat89; data.try$cat89 = NULL
cat90 = data.try$cat90; data.try$cat90 = NULL
cat91 = data.try$cat91; data.try$cat91 = NULL
cat92 = data.try$cat92; data.try$cat92 = NULL
cat98 = data.try$cat98; data.try$cat98 = NULL
cat99 = data.try$cat99; data.try$cat99 = NULL
cat100 = data.try$cat100; data.try$cat100 = NULL 
cat101 = data.try$cat101; data.try$cat101 = NULL 
cat102 = data.try$cat102; data.try$cat102 = NULL
cat103 = data.try$cat103; data.try$cat103 = NULL 
cat104 = data.try$cat104; data.try$cat104 = NULL 
cat106 = data.try$cat106; data.try$cat106 = NULL
cat107 = data.try$cat107; data.try$cat107 = NULL
cat108 = data.try$cat108; data.try$cat108 = NULL
cat111 = data.try$cat111; data.try$cat111 = NULL
cat113 = data.try$cat113; data.try$cat113 = NULL
cat114 = data.try$cat114; data.try$cat114 = NULL
cat115 = data.try$cat115; data.try$cat115 = NULL
cat116 = data.try$cat116; data.try$cat116 = NULL


data.try = data.frame(data.try, cat115)

set.seed(5)
n = dim(data.try)[1]
train = sample(n,floor(n*0.7))
data.try.train = data.try[train,]
data.try.test = data.try[-train,]

lm.try = lm(loss~.,data.try.train)
summary(lm.try)
pred.try = predict(lm.try,data.try.test)
#lm.try$xlevels[["cat89"]] <- union(lm.try$xlevels[["cat89"]], levels(data.submit$cat89))
y.try = data.try.test$loss
MAE.try = mean(abs(exp(y.try) - exp(pred.try)))
MAE.try

#with cat115 (wo highly correlated variables): 1266.915
#with 115 and 87: NA
#with 115 and 89: NA
#with 115 and 90: NA
#with 90: NA
#with 115 and highly correlated variables: 1266.86
#106: NA. 101: NA. 102: NA. 103: NA
table(data.try$cat90)
options(max.print = 1000000)
```


## Data

##Using Small data set.

```{r}
set.seed(1000)
data.small = data.try
train.small = data.try.train
test.small = data.try.test
n2 = dim(train.small)[1]
val = sample(n2,floor(n2*0.8))
val.small = train.small[-val,]
train.small = train.small[val,]
```


##Linear

```{r}
fit.lm <- lm(loss~.,data=data.small)

pred.lm = predict(fit.lm, test.small)
MAElinear = mean(abs(exp(test.small$loss) - exp(pred.lm)))
MAElinear
```

##Lasso

```{r}
set.seed(1000)
ytrain.small = data.matrix(train.small[,"loss"])
Xtrain.small = data.matrix(train.small[,!(colnames(train.small) %in% c("loss"))])
Xtest.small = data.matrix(test.small[,!(colnames(train.small) %in% c("loss"))])
grid = 10^seq(4, -20, length=1000)
fit.lasso = cv.glmnet(Xtrain.small,ytrain.small,alpha=1, lambda=grid, thresh=1e-12)
plot(fit.lasso)

best.model = glmnet(Xtrain.small, ytrain.small, alpha = 1)
predict(best.model, s = fit.lasso$lambda.1se, type = "coefficients")

best.lambda=fit.lasso$lambda.min
pred.lasso = predict(fit.lasso,Xtest.small,s=best.lambda)
MAELasso = mean(abs(exp(test.small$loss) - exp(pred.lasso)))
MAELasso



```


##Boosting.

data með öllum breytum nema continuous 9 og 12, búið að taka út obs < 10 level. 
1227.14891 á kaggle
1228.434 í R
1225.518 minimum í cross validation
lambda = 0.45
ntree = 600

```{r}
n3 = dim(data.try.train)[1]
val = sample(n3,floor(0.2*n3)) 
data.try.val = data.try.train[val,]
data.try.train = data.try.train[-val,]
```

```{r}
set.seed(1000)
lambd <-  seq(0.05, 0.5, by=0.05)
ntree <- seq(200,1200,by=200)
m <- length(lambd)
l <- length(ntree)
testErr <- array(dim=c(m,l))
for (i in 1:m) {
  for(k in 1:l){
    boostCol = gbm(loss ~ ., data = data.try.train,
                    distribution = "gaussian",
                    n.trees = ntree[k], 
                    shrinkage = lambd[i])
    testPred = predict(boostCol, data.try.val, n.trees = ntree[k])
    testErr[i,k] = mean(abs(exp(data.try.val$loss) - exp(testPred)))
    print(i)
  }
}

which(testErr == min(testErr),arr.ind = T)

bestlam = lambd[9]
bestntree = ntree[3]
testErr
lambd
ntree
bestLam = lambd[which.min(testErr)]

boostPlot =ggplot(data.frame(x=lambd, y=testErr), aes(x=x, y=y)) +
            xlab("Shrinkage") + 
            ylab("Test MSE") + 
            geom_point()


boostPlot
```

```{r,eval = T}
set.seed(1000)
boost.fit <- gbm(loss ~ ., data = data.try.train,
                 distribution = "gaussian",
                 n.trees = bestntree, shrinkage =bestlam )
boost.pred <- predict(boost.fit,
                      data.try.test,
                      n.trees = bestntree)
boost.pred2 <- predict(boost.fit,
                      data.submit,
                      n.trees = bestntree)
MAEBoost = mean(abs(exp(data.try.test$loss) - exp(boost.pred)))
MAEBoost 
```


##SUBMIT

```{r}
pred.submit = predict(fit.lm,data.submit.cat)
Submit= data.frame(id,loss=exp(boost.pred2))
write.csv(Submit,file="Submit.csv",row.names=FALSE)
```

